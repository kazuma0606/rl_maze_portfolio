# 要件定義書 - Phase 2

## はじめに

RL Maze Phase 2は、Phase 1で構築した基盤の上に、トレーニングUIを追加し、エンタープライズ水準の運用機能を強化するフェーズである。本フェーズでは、ユーザーがWebUIからトレーニングを開始・監視・停止できる機能を実装し、MLflowとの統合を強化する。

Phase 1で既に実装済みの要素：
- Go推論サーバー（APIゲートウェイ機能を含む）
- Python訓練サービス（FastAPI + WebSocket進捗ストリーミング + MLflow統合）
- OpenAPI定義の基礎
- Docker化の基礎（docker-compose.yml）

Phase 2で新規実装する要素：
- トレーニングUI（Next.js）
  - トレーニング設定フォーム
  - トレーニング進捗のリアルタイム表示
  - 実験履歴・詳細表示
  - MLflowダッシュボードへのリンク統合
  - トレーニング完了後のモデル切り替え機能

## 用語集

- **システム**: RL Maze Phase 2システム全体
- **トレーニングUI**: Next.jsで実装されたトレーニング管理画面
- **訓練サービス**: Python + FastAPIによるRL訓練パイプライン（Phase 1で実装済み）
- **推論サーバー**: Go + Ginによる推論APIサーバー（Phase 1で実装済み）
- **MLflow**: 実験トラッキング・メトリクス記録システム
- **実験**: MLflowで管理される1回の訓練実行

## 要件

### 要件1

**ユーザーストーリー:** ユーザーとして、WebUIからトレーニングを開始したい。そうすることでコマンドラインを使わずに訓練を実行できる。

#### 受け入れ条件

1. ユーザーがトレーニングUIにアクセスしたとき、システムはトレーニング設定フォームを表示しなければならない
2. ユーザーがアルゴリズム（PPO/DQN）を選択したとき、システムは選択を受け付けなければならない
3. ユーザーがエピソード数を入力したとき、システムは1-10000の範囲でバリデーションしなければならない
4. ユーザーが迷路サイズを選択したとき、システムは5-20の範囲でバリデーションしなければならない
5. ユーザーが「トレーニング開始」ボタンをクリックしたとき、システムは訓練サービスにリクエストを送信しなければならない
6. 訓練サービスがトレーニングを開始したとき、システムは一意のexperiment_idを返さなければならない

### 要件2

**ユーザーストーリー:** ユーザーとして、トレーニングの進捗をリアルタイムで監視したい。そうすることで訓練が正常に進行しているか確認できる。

#### 受け入れ条件

1. トレーニングが開始されたとき、システムは進捗表示画面に遷移しなければならない
2. システムがトレーニング進捗を受信したとき、現在のエピソード数を表示しなければならない
3. システムがトレーニング進捗を受信したとき、現在の報酬を表示しなければならない
4. システムがトレーニング進捗を受信したとき、現在の損失値を表示しなければならない
5. システムがトレーニング進捗を受信したとき、現在の成功率を表示しなければならない
6. システムがトレーニング進捗を受信したとき、報酬曲線をリアルタイムで更新しなければならない
7. システムがトレーニング進捗を受信したとき、成功率曲線をリアルタイムで更新しなければならない
8. トレーニング進捗の更新間隔は10秒以内でなければならない

### 要件3

**ユーザーストーリー:** ユーザーとして、トレーニングを停止したい。そうすることで不要な訓練を中断できる。

#### 受け入れ条件

1. トレーニング進行中にユーザーが「停止」ボタンをクリックしたとき、システムは訓練サービスに停止リクエストを送信しなければならない
2. 訓練サービスが停止リクエストを受け取ったとき、システムは現在のエピソードを完了してから停止しなければならない
3. トレーニングが停止したとき、システムは停止ステータスを表示しなければならない
4. トレーニングが停止したとき、システムは最終メトリクスを表示しなければならない

### 要件4

**ユーザーストーリー:** ユーザーとして、過去のトレーニング実行履歴を確認したい。そうすることで訓練の改善点を見つけられる。

#### 受け入れ条件

1. ユーザーがトレーニング履歴画面にアクセスしたとき、システムはMLflowから実験一覧を取得しなければならない
2. システムが実験一覧を表示するとき、experiment_id・アルゴリズム・開始日時・成功率を含まなければならない
3. ユーザーが実験をクリックしたとき、システムは実験詳細画面に遷移しなければならない
4. 実験詳細画面は、エピソード報酬・エピソード長・損失・成功率のグラフを表示しなければならない
5. 実験詳細画面は、MLflowダッシュボードへのリンクを提供しなければならない

### 要件5

**ユーザーストーリー:** ユーザーとして、トレーニング完了後に訓練済みモデルを推論UIで使用したい。そうすることで訓練結果を即座に確認できる。

#### 受け入れ条件

1. トレーニングが完了したとき、システムは訓練済みモデルをONNX形式に自動変換しなければならない（Phase 1で実装済み）
2. トレーニングが完了したとき、システムはモデルメタデータをPostgreSQLに登録しなければならない（Phase 1で実装済み）
3. トレーニング完了画面は、「推論UIで使用する」ボタンを表示しなければならない
4. ユーザーが「推論UIで使用する」ボタンをクリックしたとき、システムはアクティブモデルを切り替えなければならない
5. アクティブモデルが切り替わったとき、システムは推論UI画面に遷移しなければならない

### 要件6

**ユーザーストーリー:** 開発者として、トレーニングUIのコンポーネントが再利用可能であってほしい。そうすることで将来の拡張が容易になる。

#### 受け入れ条件

1. トレーニング設定フォームは独立したコンポーネントでなければならない
2. 進捗表示コンポーネントは独立したコンポーネントでなければならない
3. メトリクスグラフコンポーネントは独立したコンポーネントでなければならない
4. 実験一覧コンポーネントは独立したコンポーネントでなければならない
5. 各コンポーネントはTypeScriptで型定義されなければならない
6. 各コンポーネントはZodでバリデーションされなければならない

### 要件7

**ユーザーストーリー:** 開発者として、トレーニングUIと訓練サービス間の通信が型安全であってほしい。そうすることでバグを早期に発見できる。

#### 受け入れ条件

1. トレーニング開始リクエストはZodスキーマでバリデーションされなければならない
2. トレーニング進捗レスポンスはZodスキーマでバリデーションされなければならない
3. 実験一覧レスポンスはZodスキーマでバリデーションされなければならない
4. 無効なリクエストに対して、システムは明確なエラーメッセージを表示しなければならない

### 要件8

**ユーザーストーリー:** ユーザーとして、トレーニングUIが直感的で使いやすいものであってほしい。そうすることでストレスなく訓練を実行できる。

#### 受け入れ条件

1. トレーニング設定フォームは、各フィールドにラベルとヘルプテキストを表示しなければならない
2. バリデーションエラーは、該当フィールドの下に赤色で表示されなければならない
3. トレーニング開始ボタンは、フォームが無効な間は無効化されなければならない
4. トレーニング進行中は、ローディングインジケーターを表示しなければならない
5. トレーニング完了時は、成功メッセージを表示しなければならない
6. エラー発生時は、エラーメッセージとリトライボタンを表示しなければならない

## ガードレール（禁止事項）

### アーキテクチャ制約

1. **Phase 1の設計原則を維持**: Phase 1で確立したクリーンアーキテクチャ・型安全性・バリデーション戦略を維持する。
2. **コンポーネントの独立性**: トレーニングUIのコンポーネントは、推論UIのコンポーネントと独立して動作しなければならない。

### 技術制約

1. **フロントエンドでのJavaScript禁止**: フロントエンドはTypeScriptのみを使用する。JavaScriptファイル（.js）の作成は禁止。
2. **npm/yarn禁止**: パッケージマネージャーはpnpmのみを使用する。
3. **認証情報のハードコード禁止**: APIエンドポイントURLをコードにハードコードしてはならない。必ず環境変数から読み込む。

### 実装制約

1. **Phase 1の既存機能を破壊しない**: トレーニングUIの追加は、Phase 1で実装した推論UIの機能に影響を与えてはならない。
2. **WebSocketの直接接続**: トレーニング進捗のリアルタイム更新は、WebSocketを使用する。Next.js API Route経由のプロキシは禁止。

### テスト制約

1. **進捗更新間隔の計測**: トレーニング進捗の更新間隔（< 10秒）を計測するログ出力は必須。
2. **バリデーションテスト**: 全てのフォーム入力とAPIレスポンスはZodでバリデーションされなければならない。

## 成功条件（Phase 2完了条件）

Phase 2は以下の全条件を満たした時点で完了とする：

| # | 条件 | 計測方法 | 目標値 |
|---|------|---------|--------|
| 1 | トレーニング開始 | 目視確認 | WebUIからトレーニングを開始できる |
| 2 | 進捗リアルタイム表示 | 目視確認 | 報酬曲線・成功率曲線がリアルタイム更新される |
| 3 | 進捗更新間隔 | サーバーログ | < 10秒 |
| 4 | トレーニング停止 | 目視確認 | 停止ボタンでトレーニングを中断できる |
| 5 | 実験履歴表示 | 目視確認 | 過去の実験一覧が表示される |
| 6 | 実験詳細表示 | 目視確認 | 実験詳細画面でメトリクスグラフが表示される |
| 7 | モデル切り替え | 目視確認 | トレーニング完了後に推論UIでモデルを使用できる |
| 8 | バリデーション | 自動テスト | 全フォーム入力とAPIレスポンスがZodでバリデーションされる |
| 9 | エラーハンドリング | 目視確認 | エラー発生時に明確なメッセージが表示される |
| 10 | Phase 1機能の維持 | 自動テスト | Phase 1の全テストが通過する |

## 非機能要件

### パフォーマンス

- トレーニング進捗更新間隔: < 10秒
- UI応答性: ボタンクリックから画面遷移まで < 500ms

### 観測可能性

- トレーニング進捗ログ: timestamp, experiment_id, episode, reward, loss, success_rate
- エラーログ: timestamp, level, error_message, stack_trace

### 保守性

- コンポーネントの独立性: 各コンポーネントは独立してテスト可能
- 型安全性: 全てのAPIリクエスト・レスポンスはTypeScript + Zodで型定義

### 移植性

- Phase 1との互換性: Phase 1の全機能が引き続き動作する
- 環境変数による設定管理: NEXT_PUBLIC_TRAINING_API_URL, NEXT_PUBLIC_MLFLOW_URL
